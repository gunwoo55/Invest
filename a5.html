<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ì˜íˆ¬ì ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-container">
                <a href="index.html" class="logo">ğŸ’¼ íˆ¬ìê´€ë¦¬</a>
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">í™ˆ</a></li>
                    <li><a href="a2.html" class="nav-link">ë‰´ìŠ¤</a></li>
                    <li><a href="a5.html" class="nav-link active">ëª¨ì˜íˆ¬ì</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
        <div class="container">
            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="overview">í¬íŠ¸í´ë¦¬ì˜¤</button>
                <button class="tab-button" data-tab="trading">ì£¼ì‹ê±°ë˜</button>
                <button class="tab-button" data-tab="savings">ì˜ˆì ê¸ˆ</button>
                <button class="tab-button" data-tab="ledger">ê°€ê³„ë¶€</button>
            </div>

            <!-- í¬íŠ¸í´ë¦¬ì˜¤ ê°œìš” -->
            <div id="overview" class="tab-content active">
                <div class="card">
                    <h2 class="card-title">ğŸ’° í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©</h2>
                    <div class="portfolio-grid">
                        <div class="portfolio-item">
                            <div class="portfolio-symbol">ì´ ìì‚°</div>
                            <div class="portfolio-price" id="totalAssets">â‚©0</div>
                            <div class="portfolio-change" id="totalChange">+0.00%</div>
                        </div>
                        <div class="portfolio-item">
                            <div class="portfolio-symbol">íˆ¬ìê¸ˆ</div>
                            <div class="portfolio-price" id="investedAmount">â‚©0</div>
                            <div class="portfolio-change">ì›ê¸ˆ</div>
                        </div>
                        <div class="portfolio-item">
                            <div class="portfolio-symbol">í‰ê°€ì†ìµ</div>
                            <div class="portfolio-price" id="profitLoss">â‚©0</div>
                            <div class="portfolio-change" id="profitLossPercent">0.00%</div>
                        </div>
                        <div class="portfolio-item">
                            <div class="portfolio-symbol">ë³´ìœ  í˜„ê¸ˆ</div>
                            <div class="portfolio-price" id="availableCash">â‚©10,000,000</div>
                            <div class="portfolio-change">ê°€ìš©ìê¸ˆ</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ“Š ë³´ìœ  ì¢…ëª©</h3>
                    <div id="holdingsTable">
                        <p class="text-center" style="color: #7f8c8d; padding: 2rem;">
                            ë³´ìœ  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ“ˆ ê±°ë˜ ë‚´ì—­</h3>
                    <div id="transactionHistory">
                        <p class="text-center" style="color: #7f8c8d; padding: 2rem;">
                            ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ì£¼ì‹ê±°ë˜ -->
            <div id="trading" class="tab-content">
                <div class="card">
                    <h2 class="card-title">ğŸ“ˆ ì£¼ì‹ ê±°ë˜</h2>
                    
                    <!-- ì¢…ëª© ê²€ìƒ‰ -->
                    <div class="form-group">
                        <label class="form-label">ì¢…ëª© ì„ íƒ:</label>
                        <select id="stockSelect" class="form-input">
                            <option value="">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="AAPL">Apple Inc. (AAPL)</option>
                            <option value="GOOGL">Alphabet Inc. (GOOGL)</option>
                            <option value="TSLA">Tesla Inc. (TSLA)</option>
                            <option value="MSFT">Microsoft Corp. (MSFT)</option>
                            <option value="AMZN">Amazon.com Inc. (AMZN)</option>
                        </select>
                    </div>

                    <!-- ì„ íƒëœ ì¢…ëª© ì •ë³´ -->
                    <div id="stockInfo" class="hidden">
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                            <div class="flex justify-between align-center">
                                <div>
                                    <h4 id="stockName" style="margin-bottom: 0.5rem;">-</h4>
                                    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;" id="stockPrice">$0.00</div>
                                </div>
                                <div style="text-align: right;">
                                    <div id="stockChange" class="portfolio-change">+0.00%</div>
                                    <div style="font-size: 0.9rem; color: #7f8c8d;">ì‹¤ì‹œê°„ ê°€ê²©</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ê±°ë˜ í¼ -->
                    <div id="tradingForm" class="hidden">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div class="card">
                                <h4 style="color: #27ae60; margin-bottom: 1rem;">ğŸ“ˆ ë§¤ìˆ˜</h4>
                                <div class="form-group">
                                    <label class="form-label">ìˆ˜ëŸ‰:</label>
                                    <input type="number" id="buyQuantity" class="form-input" min="1" placeholder="ë§¤ìˆ˜í•  ìˆ˜ëŸ‰">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ì˜ˆìƒ ì´ì•¡:</label>
                                    <div id="buyTotal" style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">$0.00</div>
                                </div>
                                <button class="btn btn-success" onclick="executeTrade('buy')">ë§¤ìˆ˜ ì£¼ë¬¸</button>
                            </div>
                            
                            <div class="card">
                                <h4 style="color: #e74c3c; margin-bottom: 1rem;">ğŸ“‰ ë§¤ë„</h4>
                                <div class="form-group">
                                    <label class="form-label">ìˆ˜ëŸ‰:</label>
                                    <input type="number" id="sellQuantity" class="form-input" min="1" placeholder="ë§¤ë„í•  ìˆ˜ëŸ‰">
                                    <small id="maxSellQuantity" style="color: #7f8c8d;"></small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ì˜ˆìƒ ì´ì•¡:</label>
                                    <div id="sellTotal" style="font-size: 1.2rem; font-weight: bold; color: #e74c3c;">$0.00</div>
                                </div>
                                <button class="btn btn-danger" onclick="executeTrade('sell')">ë§¤ë„ ì£¼ë¬¸</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì‹¤ì‹œê°„ ì‹œì¥ í˜„í™© -->
                <div class="card">
                    <h3 class="card-title">ğŸŒ ì‹¤ì‹œê°„ ì‹œì¥ í˜„í™©</h3>
                    <div id="marketData">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>ì‹œì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜ˆì ê¸ˆ -->
            <div id="savings" class="tab-content">
                <div class="card">
                    <h2 class="card-title">ğŸ¦ ì˜ˆì ê¸ˆ ê´€ë¦¬</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div class="card">
                            <h4 style="color: #3498db; margin-bottom: 1rem;">ğŸ’° ì˜ˆê¸ˆ ê°€ì…</h4>
                            <div class="form-group">
                                <label class="form-label">ì˜ˆê¸ˆ ì¢…ë¥˜:</label>
                                <select id="depositType" class="form-input">
                                    <option value="ì •ê¸°ì˜ˆê¸ˆ">ì •ê¸°ì˜ˆê¸ˆ</option>
                                    <option value="ììœ ì ê¸ˆ">ììœ ì ê¸ˆ</option>
                                    <option value="ì •ê¸°ì ê¸ˆ">ì •ê¸°ì ê¸ˆ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ê°€ì… ê¸ˆì•¡ (ì›):</label>
                                <input type="number" id="depositAmount" class="form-input" min="10000" step="10000" placeholder="ìµœì†Œ 1ë§Œì›">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ê¸°ê°„ (ê°œì›”):</label>
                                <select id="depositTerm" class="form-input">
                                    <option value="3">3ê°œì›” (ì—° 2.5%)</option>
                                    <option value="6">6ê°œì›” (ì—° 2.8%)</option>
                                    <option value="12">12ê°œì›” (ì—° 3.2%)</option>
                                    <option value="24">24ê°œì›” (ì—° 3.5%)</option>
                                    <option value="36">36ê°œì›” (ì—° 3.8%)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì˜ˆìƒ ë§Œê¸° ê¸ˆì•¡:</label>
                                <div id="expectedReturn" style="font-size: 1.2rem; font-weight: bold; color: #3498db;">â‚©0</div>
                            </div>
                            <button class="btn btn-success" onclick="subscribeSavings()">ê°€ì…í•˜ê¸°</button>
                        </div>
                        
                        <div class="card">
                            <h4 style="color: #9b59b6; margin-bottom: 1rem;">ğŸ“‹ ê°€ì… ìƒí’ˆ ëª©ë¡</h4>
                            <div id="savingsList">
                                <p class="text-center" style="color: #7f8c8d;">ê°€ì…í•œ ì˜ˆì ê¸ˆ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê°€ê³„ë¶€ -->
            <div id="ledger" class="tab-content">
                <div class="card">
                    <h2 class="card-title">ğŸ“ ê°€ê³„ë¶€ ê´€ë¦¬</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                        <div class="card">
                            <h4 style="margin-bottom: 1rem;">ìƒˆ í•­ëª© ì¶”ê°€</h4>
                            <div class="form-group">
                                <label class="form-label">ë‚ ì§œ:</label>
                                <input type="date" id="ledgerDate" class="form-input" value="">
                            </div>
                            <div class="form-group">
                                <label class="form-label">êµ¬ë¶„:</label>
                                <select id="ledgerType" class="form-input">
                                    <option value="income">ìˆ˜ì…</option>
                                    <option value="expense">ì§€ì¶œ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì¹´í…Œê³ ë¦¬:</label>
                                <select id="ledgerCategory" class="form-input">
                                    <option value="ê¸‰ì—¬">ê¸‰ì—¬</option>
                                    <option value="ìš©ëˆ">ìš©ëˆ</option>
                                    <option value="ì‹ë¹„">ì‹ë¹„</option>
                                    <option value="êµí†µë¹„">êµí†µë¹„</option>
                                    <option value="ì‡¼í•‘">ì‡¼í•‘</option>
                                    <option value="ê¸ˆìœµìƒí’ˆ">ê¸ˆìœµìƒí’ˆ</option>
                                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ê¸ˆì•¡ (ì›):</label>
                                <input type="number" id="ledgerAmount" class="form-input" min="1" placeholder="ê¸ˆì•¡ ì…ë ¥">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë‚´ìš©:</label>
                                <input type="text" id="ledgerDescription" class="form-input" placeholder="ìƒì„¸ ë‚´ìš©">
                            </div>
                            <button class="btn btn-success" onclick="addLedgerEntry()">ì¶”ê°€</button>
                        </div>
                        
                        <div class="card">
                            <div class="flex justify-between align-center mb-2">
                                <h4>ê°€ê³„ë¶€ ë‚´ì—­</h4>
                                <div>
                                    <button class="btn btn-secondary" onclick="exportLedger()">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                                </div>
                            </div>
                            <div id="ledgerSummary" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #e8f5e8; padding: 1rem; border-radius: 4px; text-align: center;">
                                    <div style="color: #27ae60; font-weight: bold;">ì´ ìˆ˜ì…</div>
                                    <div id="totalIncome" style="font-size: 1.2rem; font-weight: bold;">â‚©0</div>
                                </div>
                                <div style="background: #ffeaea; padding: 1rem; border-radius: 4px; text-align: center;">
                                    <div style="color: #e74c3c; font-weight: bold;">ì´ ì§€ì¶œ</div>
                                    <div id="totalExpense" style="font-size: 1.2rem; font-weight: bold;">â‚©0</div>
                                </div>
                                <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; text-align: center;">
                                    <div style="color: #2196f3; font-weight: bold;">ì”ì•¡</div>
                                    <div id="balance" style="font-size: 1.2rem; font-weight: bold;">â‚©0</div>
                                </div>
                            </div>
                            <div id="ledgerTable">
                                <p class="text-center" style="color: #7f8c8d; padding: 2rem;">
                                    ê°€ê³„ë¶€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        let currentStock = null;
        let stockPrices = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            document.getElementById('ledgerDate').value = new Date().toISOString().split('T')[0];
            
            // ë°ì´í„° ë¡œë“œ
            updatePortfolioOverview();
            loadMarketData();
            loadSavingsList();
            updateLedgerDisplay();
            
            // ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘
            startRealTimeUpdates();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            setupEventListeners();
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ì¢…ëª© ì„ íƒ ì‹œ
            document.getElementById('stockSelect').addEventListener('change', function() {
                const symbol = this.value;
                if (symbol) {
                    loadStockInfo(symbol);
                } else {
                    document.getElementById('stockInfo').classList.add('hidden');
                    document.getElementById('tradingForm').classList.add('hidden');
                }
            });

            // ìˆ˜ëŸ‰ ì…ë ¥ ì‹œ ì´ì•¡ ê³„ì‚°
            document.getElementById('buyQuantity').addEventListener('input', updateTradingCalculations);
            document.getElementById('sellQuantity').addEventListener('input', updateTradingCalculations);

            // ì˜ˆì ê¸ˆ ê³„ì‚°
            document.getElementById('depositAmount').addEventListener('input', calculateExpectedReturn);
            document.getElementById('depositTerm').addEventListener('change', calculateExpectedReturn);
        }

        // ì¢…ëª© ì •ë³´ ë¡œë“œ
        async function loadStockInfo(symbol) {
            const stockData = await API.getStockPrice(symbol);
            stockPrices[symbol] = stockData;
            currentStock = symbol;

            document.getElementById('stockName').textContent = symbol;
            document.getElementById('stockPrice').textContent = `$${stockData.price.toFixed(2)}`;
            document.getElementById('stockChange').textContent = formatPercent(stockData.changePercent);
            document.getElementById('stockChange').className = `portfolio-change ${stockData.changePercent >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('stockInfo').classList.remove('hidden');
            document.getElementById('tradingForm').classList.remove('hidden');

            // ë³´ìœ  ìˆ˜ëŸ‰ í‘œì‹œ
            const holdings = portfolio.data.holdings[symbol];
            const maxSell = holdings ? holdings.quantity : 0;
            document.getElementById('maxSellQuantity').textContent = `ë³´ìœ : ${maxSell}ì£¼`;
        }

        // ê±°ë˜ ê³„ì‚° ì—…ë°ì´íŠ¸
        function updateTradingCalculations() {
            if (!currentStock || !stockPrices[currentStock]) return;

            const price = stockPrices[currentStock].price;
            const buyQuantity = parseInt(document.getElementById('buyQuantity').value) || 0;
            const sellQuantity = parseInt(document.getElementById('sellQuantity').value) || 0;

            document.getElementById('buyTotal').textContent = `$${(buyQuantity * price).toFixed(2)}`;
            document.getElementById('sellTotal').textContent = `$${(sellQuantity * price).toFixed(2)}`;
        }

        // ê±°ë˜ ì‹¤í–‰
        function executeTrade(type) {
            if (!currentStock) {
                alert('ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const price = stockPrices[currentStock].price * 1328.5; // USD to KRW
            const quantity = parseInt(document.getElementById(type + 'Quantity').value);

            if (!quantity || quantity <= 0) {
                alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                if (type === 'buy') {
                    portfolio.buyStock(currentStock, quantity, price);
                    showSuccess(`${currentStock} ${quantity}ì£¼ë¥¼ ë§¤ìˆ˜í–ˆìŠµë‹ˆë‹¤.`);
                } else {
                    portfolio.sellStock(currentStock, quantity, price);
                    showSuccess(`${currentStock} ${quantity}ì£¼ë¥¼ ë§¤ë„í–ˆìŠµë‹ˆë‹¤.`);
                }

                // UI ì—…ë°ì´íŠ¸
                updatePortfolioOverview();
                loadStockInfo(currentStock); // ë³´ìœ  ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById(type + 'Quantity').value = '';
                updateTradingCalculations();

            } catch (error) {
                alert('ê±°ë˜ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í¬íŠ¸í´ë¦¬ì˜¤ ê°œìš” ì—…ë°ì´íŠ¸
        async function updatePortfolioOverview() {
            const currentValue = await portfolio.getCurrentValue();
            const returnData = await portfolio.getReturn();

            document.getElementById('totalAssets').textContent = formatCurrency(currentValue);
            document.getElementById('availableCash').textContent = formatCurrency(portfolio.data.totalAssets);
            document.getElementById('investedAmount').textContent = formatCurrency(10000000 - portfolio.data.totalAssets);
            document.getElementById('profitLoss').textContent = formatCurrency(returnData.amount);
            document.getElementById('profitLossPercent').textContent = formatPercent(returnData.percent);
            document.getElementById('profitLossPercent').className = `portfolio-change ${returnData.amount >= 0 ? 'positive' : 'negative'}`;

            // ë³´ìœ  ì¢…ëª© í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateHoldingsTable();
            updateTransactionHistory();
        }

        // ë³´ìœ  ì¢…ëª© í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateHoldingsTable() {
            const holdings = portfolio.data.holdings;
            const container = document.getElementById('holdingsTable');

            if (Object.keys(holdings).length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #7f8c8d; padding: 2rem;">ë³´ìœ  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            
            let tableHTML = `
                <thead>
                    <tr>
                        <th>ì¢…ëª©</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>í‰ê· ë‹¨ê°€</th>
                        <th>í˜„ì¬ê°€</th>
                        <th>í‰ê°€ê¸ˆì•¡</th>
                        <th>ì†ìµ</th>
                    </tr>
                </thead>
                <tbody>
            `;

            for (const [symbol, holding] of Object.entries(holdings)) {
                const currentPrice = stockPrices[symbol]?.price * 1328.5 || holding.avgPrice;
                const currentValue = holding.quantity * currentPrice;
                const investedValue = holding.quantity * holding.avgPrice;
                const profitLoss = currentValue - investedValue;
                const profitPercent = (profitLoss / investedValue) * 100;

                tableHTML += `
                    <tr>
                        <td>${symbol}</td>
                        <td>${holding.quantity}</td>
                        <td>${formatCurrency(holding.avgPrice)}</td>
                        <td>${formatCurrency(currentPrice)}</td>
                        <td>${formatCurrency(currentValue)}</td>
                        <td class="${profitLoss >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(profitLoss)}<br>
                            <small>(${formatPercent(profitPercent)})</small>
                        </td>
                    </tr>
                `;
            }

            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            container.innerHTML = '';
            container.appendChild(table);
        }

        // ê±°ë˜ ë‚´ì—­ ì—…ë°ì´íŠ¸
        function updateTransactionHistory() {
            const transactions = portfolio.data.transactions.slice(-10).reverse();
            const container = document.getElementById('transactionHistory');

            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #7f8c8d; padding: 2rem;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì¢…ëª©</th>
                        <th>êµ¬ë¶„</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ë‹¨ê°€</th>
                        <th>ì´ì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    ${transactions.map(transaction => `
                        <tr>
                            <td>${formatDate(transaction.date)}</td>
                            <td>${transaction.symbol || transaction.savingsType || 'ì˜ˆì ê¸ˆ'}</td>
                            <td style="color: ${transaction.type === 'buy' ? '#27ae60' : transaction.type === 'sell' ? '#e74c3c' : '#3498db'}">
                                ${transaction.type === 'buy' ? 'ë§¤ìˆ˜' : transaction.type === 'sell' ? 'ë§¤ë„' : 'ê°€ì…'}
                            </td>
                            <td>${transaction.quantity || '-'}</td>
                            <td>${transaction.price ? formatCurrency(transaction.price) : '-'}</td>
                            <td>${formatCurrency(transaction.total || transaction.amount)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        // ì‹œì¥ ë°ì´í„° ë¡œë“œ
        function loadMarketData() {
            setTimeout(() => {
                const marketItems = [
                    { symbol: 'AAPL', name: 'Apple Inc.', price: 150.25, change: 2.15 },
                    { symbol: 'GOOGL', name: 'Alphabet Inc.', price: 2650.80, change: -15.30 },
                    { symbol: 'TSLA', name: 'Tesla Inc.', price: 245.60, change: 8.90 },
                    { symbol: 'MSFT', name: 'Microsoft Corp.', price: 310.45, change: 1.20 },
                    { symbol: 'AMZN', name: 'Amazon.com Inc.', price: 135.75, change: -2.85 }
                ];

                document.getElementById('marketData').innerHTML = `
                    <div class="portfolio-grid">
                        ${marketItems.map(item => `
                            <div class="portfolio-item" style="cursor: pointer;" onclick="selectStock('${item.symbol}')">
                                <div class="portfolio-symbol">${item.symbol}</div>
                                <div class="portfolio-price">$${item.price.toFixed(2)}</div>
                                <div class="portfolio-change ${item.change >= 0 ? 'positive' : 'negative'}">
                                    ${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }, 1000);
        }

        // ì¢…ëª© ì„ íƒ
        function selectStock(symbol) {
            document.getElementById('stockSelect').value = symbol;
            loadStockInfo(symbol);
            
            // ì£¼ì‹ê±°ë˜ íƒ­ìœ¼ë¡œ ì´ë™
            document.querySelector('[data-tab="trading"]').click();
        }

        // ì˜ˆì ê¸ˆ ì˜ˆìƒ ìˆ˜ìµ ê³„ì‚°
        function calculateExpectedReturn() {
            const amount = parseInt(document.getElementById('depositAmount').value) || 0;
            const termSelect = document.getElementById('depositTerm');
            const term = parseInt(termSelect.value);
            const rate = parseFloat(termSelect.selectedOptions[0].text.match(/ì—° ([\d.]+)%/)[1]);

            if (amount > 0 && term > 0) {
                const expectedReturn = amount * (1 + (rate / 100) * (term / 12));
                document.getElementById('expectedReturn').textContent = formatCurrency(expectedReturn);
            } else {
                document.getElementById('expectedReturn').textContent = 'â‚©0';
            }
        }

        // ì˜ˆì ê¸ˆ ê°€ì…
        function subscribeSavings() {
            const amount = parseInt(document.getElementById('depositAmount').value);
            const type = document.getElementById('depositType').value;
            const termSelect = document.getElementById('depositTerm');
            const term = parseInt(termSelect.value);
            const rate = parseFloat(termSelect.selectedOptions[0].text.match(/ì—° ([\d.]+)%/)[1]);

            if (!amount || amount < 10000) {
                alert('ìµœì†Œ ê°€ì… ê¸ˆì•¡ì€ 1ë§Œì›ì…ë‹ˆë‹¤.');
                return;
            }

            if (amount > portfolio.data.totalAssets) {
                alert('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                return;
            }

            try {
                portfolio.addSavings(amount, type, rate, term);
                showSuccess(`${type}ì— ${formatCurrency(amount)}ìœ¼ë¡œ ê°€ì…í–ˆìŠµë‹ˆë‹¤.`);
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('depositAmount').value = '';
                document.getElementById('expectedReturn').textContent = 'â‚©0';
                
                // UI ì—…ë°ì´íŠ¸
                updatePortfolioOverview();
                loadSavingsList();
                updateLedgerDisplay();
                
            } catch (error) {
                alert('ê°€ì… ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì˜ˆì ê¸ˆ ëª©ë¡ ë¡œë“œ
        function loadSavingsList() {
            const savingsTransactions = portfolio.data.transactions.filter(t => t.type === 'savings');
            const container = document.getElementById('savingsList');

            if (savingsTransactions.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #7f8c8d;">ê°€ì…í•œ ì˜ˆì ê¸ˆ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = savingsTransactions.map(savings => {
                const maturityDate = new Date(savings.maturityDate);
                const isMatured = maturityDate <= new Date();
                const daysLeft = Math.ceil((maturityDate - new Date()) / (1000 * 60 * 60 * 24));

                return `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                        <h5 style="color: #2c3e50; margin-bottom: 0.5rem;">${savings.savingsType}</h5>
                        <p style="margin-bottom: 0.5rem;">ê°€ì…ê¸ˆì•¡: ${formatCurrency(savings.amount)}</p>
                        <p style="margin-bottom: 0.5rem;">ê¸ˆë¦¬: ${savings.interestRate}%</p>
                        <p style="margin-bottom: 0.5rem;">ë§Œê¸°ì¼: ${formatDate(savings.maturityDate)}</p>
                        <p style="color: ${isMatured ? '#e74c3c' : '#27ae60'};">
                            ${isMatured ? 'ë§Œë£Œë¨' : `${daysLeft}ì¼ ë‚¨ìŒ`}
                        </p>
                    </div>
                `;
            }).join('');
        }

        // ê°€ê³„ë¶€ í•­ëª© ì¶”ê°€
        function addLedgerEntry() {
            const date = document.getElementById('ledgerDate').value;
            const type = document.getElementById('ledgerType').value;
            const category = document.getElementById('ledgerCategory').value;
            const amount = parseInt(document.getElementById('ledgerAmount').value);
            const description = document.getElementById('ledgerDescription').value;

            if (!date || !amount || !description) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            portfolio.addToLedger({
                date: new Date(date).toISOString(),
                type,
                category,
                amount: type === 'income' ? amount : -amount,
                description
            });

            // í¼ ì´ˆê¸°í™”
            document.getElementById('ledgerAmount').value = '';
            document.getElementById('ledgerDescription').value = '';

            // UI ì—…ë°ì´íŠ¸
            updateLedgerDisplay();
            showSuccess('ê°€ê³„ë¶€ì— í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ê°€ê³„ë¶€ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateLedgerDisplay() {
            const ledger = portfolio.data.ledger;
            const container = document.getElementById('ledgerTable');

            // ìš”ì•½ ì •ë³´ ê³„ì‚°
            let totalIncome = 0;
            let totalExpense = 0;

            ledger.forEach(entry => {
                if (entry.amount > 0) {
                    totalIncome += entry.amount;
                } else {
                    totalExpense += Math.abs(entry.amount);
                }
            });

            const balance = totalIncome - totalExpense;

            // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('balance').textContent = formatCurrency(balance);

            if (ledger.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #7f8c8d; padding: 2rem;">ê°€ê³„ë¶€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ìµœê·¼ 20ê°œ í•­ëª©ë§Œ í‘œì‹œ
            const recentEntries = ledger.slice(-20).reverse();

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>êµ¬ë¶„</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ë‚´ìš©</th>
                        <th>ê¸ˆì•¡</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentEntries.map(entry => `
                        <tr>
                            <td>${formatDate(entry.date)}</td>
                            <td style="color: ${entry.amount > 0 ? '#27ae60' : '#e74c3c'}">
                                ${entry.amount > 0 ? 'ìˆ˜ì…' : 'ì§€ì¶œ'}
                            </td>
                            <td>${entry.category}</td>
                            <td>${entry.description}</td>
                            <td style="color: ${entry.amount > 0 ? '#27ae60' : '#e74c3c'}">
                                ${formatCurrency(Math.abs(entry.amount))}
                            </td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="editLedgerEntry(${entry.id})">ìˆ˜ì •</button>
                                <button class="btn btn-danger" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.5rem;" onclick="deleteLedgerEntry(${entry.id})">ì‚­ì œ</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        // ê°€ê³„ë¶€ í•­ëª© ìˆ˜ì •
        function editLedgerEntry(id) {
            const entry = portfolio.data.ledger.find(e => e.id === id);
            if (!entry) return;

            const newDescription = prompt('ìƒˆë¡œìš´ ë‚´ìš©:', entry.description);
            const newAmount = prompt('ìƒˆë¡œìš´ ê¸ˆì•¡:', Math.abs(entry.amount));

            if (newDescription && newAmount) {
                portfolio.updateLedgerEntry(id, {
                    description: newDescription,
                    amount: entry.amount > 0 ? parseInt(newAmount) : -parseInt(newAmount)
                });
                updateLedgerDisplay();
                showSuccess('ê°€ê³„ë¶€ í•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê°€ê³„ë¶€ í•­ëª© ì‚­ì œ
        function deleteLedgerEntry(id) {
            if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                portfolio.deleteLedgerEntry(id);
                updateLedgerDisplay();
                showSuccess('ê°€ê³„ë¶€ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê°€ê³„ë¶€ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
        function exportLedger() {
            const ledger = portfolio.data.ledger;
            let csv = 'ë‚ ì§œ,êµ¬ë¶„,ì¹´í…Œê³ ë¦¬,ë‚´ìš©,ê¸ˆì•¡\n';
            
            ledger.forEach(entry => {
                csv += `${entry.date.split('T')[0]},${entry.amount > 0 ? 'ìˆ˜ì…' : 'ì§€ì¶œ'},${entry.category},"${entry.description}",${Math.abs(entry.amount)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ê°€ê³„ë¶€_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸
        function startRealTimeUpdates() {
            setInterval(async () => {
                // í˜„ì¬ ì„ íƒëœ ì¢…ëª©ì˜ ê°€ê²© ì—…ë°ì´íŠ¸
                if (currentStock) {
                    const updatedPrice = await API.getStockPrice(currentStock);
                    stockPrices[currentStock] = updatedPrice;
                    
                    document.getElementById('stockPrice').textContent = `$${updatedPrice.price.toFixed(2)}`;
                    document.getElementById('stockChange').textContent = formatPercent(updatedPrice.changePercent);
                    document.getElementById('stockChange').className = `portfolio-change ${updatedPrice.changePercent >= 0 ? 'positive' : 'negative'}`;
                    
                    updateTradingCalculations();
                }

                // í¬íŠ¸í´ë¦¬ì˜¤ ê°’ ì—…ë°ì´íŠ¸
                updatePortfolioOverview();
                
            }, 30000); // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }
    </script>
</body>
</html>